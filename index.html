<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI è‹±è¯­è¶£å‘³å­¦ä¹ </title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #f9f9fb;
      color: #333;
    }
    h1 { text-align: center; margin-bottom: 30px; }
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin: 12px 0 6px;
      font-weight: 600;
    }
    input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      box-sizing: border-box;
    }
    button {
      background: #4f46e5;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
      transition: background 0.2s;
    }
    button:hover { background: #4338ca; }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #dialogue {
      line-height: 1.6;
      background: #f0f4ff;
      padding: 16px;
      border-radius: 8px;
      margin-top: 16px;
    }
    .dialog-line {
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px dashed #cbd5e1;
    }
    .dialog-line:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    .speaker {
      font-weight: bold;
      color: #4f46e5;
      margin-bottom: 4px;
    }
    .english {
      font-size: 17px;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .chinese {
      color: #4a5568;
      font-style: italic;
    }
    .hidden { display: none; }
    .error { color: #e11d48; margin-top: 8px; }

    /* å¯ç‚¹å‡»å•è¯æ ·å¼ */
    .clickable-word {
      cursor: pointer;
      text-decoration: underline;
      color: #2563eb;
      background: none !important;
      border: none;
      padding: 0;
      font: inherit;
      outline: none;
    }
    .clickable-word:hover {
      color: #1d4ed8;
    }
    .loading-word {
      opacity: 0.6;
    }

    /* æ’­æ”¾æŒ‰é’®æ ·å¼ */
    .play-btn {
      background: #e0f2fe;
      color: #0369a1;
      border: 1px solid #7dd3fc;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
      flex-shrink: 0;
    }
    .play-btn:hover {
      background: #bae6fd;
    }

    /* è‡ªå®šä¹‰å¼¹çª— */
    #custom-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
    }
    #custom-modal.active {
      opacity: 1;
      visibility: visible;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 12px;
      max-width: 90%;
      width: 400px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      position: relative;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .modal-title {
      font-weight: 600;
      color: #1e293b;
    }
    .close-modal {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #94a3b8;
    }
    .modal-body {
      line-height: 1.6;
      color: #334155;
    }
  </style>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2227848226864185"
     crossorigin="anonymous"></script>
</head>
<body>
  <h1>ğŸ¤– AI è‹±è¯­è¶£å‘³å­¦ä¹ </h1>

  <div class="card">
    <h2>âš™ï¸ é…ç½® AIï¼ˆåªéœ€ä¸€æ¬¡ï¼‰</h2>
    <label for="apiKey">API Key *</label>
    <input type="password" id="apiKey" placeholder="ä¾‹å¦‚ï¼šsk-xxx æˆ–ä½ çš„æœåŠ¡å¯†é’¥">

    <label for="baseUrl">Base URL *</label>
    <input type="url" id="baseUrl" placeholder="ä¾‹å¦‚ï¼šhttps://api.openai.com/v1 æˆ– https://openrouter.ai/api/v1">

    <label for="modelName">æ¨¡å‹åç§° *</label>
    <input type="text" id="modelName" placeholder="ä¾‹å¦‚ï¼šgpt-4o, claude-3.5-sonnet, llama3:8b">

    <button onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
    <div id="configStatus" class="hidden"></div>
  </div>

  <div class="card">
    <h2>ğŸ“š å¼€å§‹å­¦ä¹ </h2>
    <label for="sceneSelect">é€‰æ‹©å¸¸ç”¨åœºæ™¯ï¼š</label>
    <select id="sceneSelect">
      <option value="random">ğŸ² éšæœºåœºæ™¯</option>
      <option value="restaurant">ğŸ½ï¸ é¤å…ç‚¹é¤</option>
      <option value="hotel">ğŸ¨ é…’åº—å…¥ä½</option>
      <option value="airport">âœˆï¸ æœºåœºå€¼æœº</option>
      <option value="shopping">ğŸ›ï¸ è´­ç‰©ç ä»·</option>
      <option value="doctor">ğŸ¥ çœ‹ç—…é—®è¯Š</option>
      <option value="job_interview">ğŸ’¼ æ±‚èŒé¢è¯•</option>
      <option value="travel">ğŸŒ æ—…è¡Œé—®è·¯</option>
      <option value="casual_chat">ğŸ’¬ æ—¥å¸¸é—²èŠ</option>
    </select>
    <p>ç‚¹å‡»æŒ‰é’®ï¼ŒåŸºäºæ‰€é€‰åœºæ™¯ç”Ÿæˆä¸€æ®µå¤šè½®å®ç”¨å¯¹è¯ï¼ˆå«ä¸­è‹±å¯¹ç…§ï¼‰ï¼</p>
    <button onclick="startLearning()" id="learnBtn">ğŸš€ ç”Ÿæˆè¶£å‘³å¯¹è¯</button>
    <div id="error" class="error hidden"></div>
    <div id="dialogue"></div>
  </div>

  <!-- è‡ªå®šä¹‰å¼¹çª— -->
  <div id="custom-modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">å•è¯é‡Šä¹‰</div>
        <button class="close-modal" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
    </div>
  </div>

  <script>
    // ä» localStorage åŠ è½½é…ç½®
    function loadConfig() {
      const apiKey = localStorage.getItem('aiApiKey');
      const baseUrl = localStorage.getItem('aiBaseUrl');
      const modelName = localStorage.getItem('aiModelName');
      if (apiKey) document.getElementById('apiKey').value = apiKey;
      if (baseUrl) document.getElementById('baseUrl').value = baseUrl;
      if (modelName) document.getElementById('modelName').value = modelName;
    }

    // ä¿å­˜é…ç½®åˆ° localStorage
    function saveConfig() {
      const apiKey = document.getElementById('apiKey').value.trim();
      const baseUrl = document.getElementById('baseUrl').value.trim();
      const modelName = document.getElementById('modelName').value.trim();

      if (!apiKey || !baseUrl || !modelName) {
        alert('è¯·å¡«å†™æ‰€æœ‰é…ç½®é¡¹ï¼');
        return;
      }

      localStorage.setItem('aiApiKey', apiKey);
      localStorage.setItem('aiBaseUrl', baseUrl);
      localStorage.setItem('aiModelName', modelName);

      const statusEl = document.getElementById('configStatus');
      statusEl.textContent = 'âœ… é…ç½®å·²ä¿å­˜ï¼';
      statusEl.classList.remove('hidden');
      setTimeout(() => statusEl.classList.add('hidden'), 3000);
    }

    // è·å–ç”¨æˆ·é€‰æ‹©çš„åœºæ™¯ï¼ˆæ”¯æŒ randomï¼‰
    function getSelectedScene() {
      const selected = document.getElementById('sceneSelect').value;
      if (selected === 'random') {
        const scenes = Object.keys(SCENE_DESCRIPTIONS);
        const randomIndex = Math.floor(Math.random() * scenes.length);
        return scenes[randomIndex];
      }
      return selected;
    }

    // åœºæ™¯æè¿°æ˜ å°„ï¼ˆç”¨äºæç¤ºè¯ï¼‰
    const SCENE_DESCRIPTIONS = {
      restaurant: "åœ¨é¤å…ç‚¹é¤ã€è¯¢é—®èœå“ã€ç»“è´¦ç­‰",
      hotel: "åœ¨é…’åº—åŠç†å…¥ä½ã€è¯¢é—®è®¾æ–½ã€é€€æˆ¿ç­‰",
      airport: "åœ¨æœºåœºåŠç†ç™»æœºã€æ‰˜è¿è¡Œæã€è¯¢é—®èˆªç­ä¿¡æ¯ç­‰",
      shopping: "åœ¨å•†åº—è´­ç‰©ã€è¯¢é—®ä»·æ ¼ã€è®¨ä»·è¿˜ä»·ã€é€€æ¢è´§ç­‰",
      doctor: "åœ¨è¯Šæ‰€æˆ–åŒ»é™¢æè¿°ç—‡çŠ¶ã€è¯¢é—®æ²»ç–—æ–¹æ¡ˆã€æ‹¿è¯ç­‰",
      job_interview: "æ±‚èŒé¢è¯•ä¸­çš„è‡ªæˆ‘ä»‹ç»ã€å›ç­”é—®é¢˜ã€æé—®ç¯èŠ‚ç­‰",
      travel: "åœ¨è¡—å¤´æˆ–æ™¯ç‚¹é—®è·¯ã€è¯¢é—®äº¤é€šã€æ¨èåœ°ç‚¹ç­‰",
      casual_chat: "æœ‹å‹ä¹‹é—´çš„æ—¥å¸¸èŠå¤©ï¼Œå¦‚å¤©æ°”ã€çˆ±å¥½ã€è¿‘å†µç­‰"
    };

    // è°ƒç”¨ AI ç”Ÿæˆå¯¹è¯ï¼ˆå¤šè½® + ä¸­è‹±å¯¹ç…§ï¼‰
    async function generateDialogue(sceneKey) {
      const apiKey = localStorage.getItem('aiApiKey');
      const baseUrl = localStorage.getItem('aiBaseUrl');
      const modelName = localStorage.getItem('aiModelName');

      if (!apiKey || !baseUrl || !modelName) {
        throw new Error('è¯·å…ˆåœ¨ä¸Šæ–¹é…ç½® AI å‚æ•°ï¼');
      }

      const sceneDesc = SCENE_DESCRIPTIONS[sceneKey] || "æ—¥å¸¸ç”Ÿæ´»åœºæ™¯";

      const prompt = `You are a JSON generator. Output ONLY valid JSON, no explanations, no markdown, no extra text.

Create a natural and practical multi-turn dialogue (4-6 exchanges) between two people in the following scenario:
"${sceneDesc}"

Rules:
- Make it realistic and useful for English learners.
- Include common phrases and expressions for this situation.
- Output EXACTLY in this JSON format:
{"dialogue":[{"speaker":"Person A","english":"English text","chinese":"Chinese translation"},{"speaker":"Person B","english":"...","chinese":"..."}]}
- Do not output anything before or after the JSON.`;

      const response = await fetch(`${baseUrl}/chat/completions`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: modelName,
          messages: [{ role: 'user', content: prompt }],
          temperature: 0.7,
          max_tokens: 600
        })
      });

      if (!response.ok) {
        const errorText = await response.text();
        console.error('AI API Error:', errorText);
        throw new Error(`AI è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
      }

      const data = await response.json();
      let content = data.choices[0].message.content.trim();

      content = content
        .replace(/^[^{]*({.*})[^}]*$/s, '$1')
        .replace(/```json?\s*/gi, '')
        .replace(/```/g, '')
        .trim();

      try {
        const result = JSON.parse(content);
        if (!Array.isArray(result.dialogue)) {
          throw new Error('Invalid dialogue format');
        }
        return result.dialogue;
      } catch (e) {
        console.error('Failed to parse AI response as JSON:', content);
        throw new Error('AI è¿”å›æ ¼å¼é”™è¯¯ï¼Œè¯·å°è¯•æ›´å¼ºæ¨¡å‹ï¼ˆå¦‚ gpt-4oï¼‰');
      }
    }

    // ä½¿ç”¨ AI ç¿»è¯‘å•ä¸ªå•è¯
    async function translateWord(word) {
      const apiKey = localStorage.getItem('aiApiKey');
      const baseUrl = localStorage.getItem('aiBaseUrl');
      const modelName = localStorage.getItem('aiModelName');

      if (!apiKey || !baseUrl || !modelName) {
        throw new Error('è¯·å…ˆé…ç½® AI å‚æ•°ï¼');
      }

      const prompt = `Translate the following English word or short phrase into Chinese. Only output the Chinese translation, nothing else: "${word}"`;

      const response = await fetch(`${baseUrl}/chat/completions`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: modelName,
          messages: [{ role: 'user', content: prompt }],
          temperature: 0.1,
          max_tokens: 20
        })
      });

      if (!response.ok) {
        throw new Error(`ç¿»è¯‘è¯·æ±‚å¤±è´¥: ${response.status}`);
      }

      const data = await response.json();
      let translation = data.choices[0].message.content.trim();
      translation = translation.replace(/^["']|["']$/g, '').trim();
      return translation || 'ï¼ˆæ— ç»“æœï¼‰';
    }

    // æ–‡å­—è½¬è¯­éŸ³ï¼ˆä½¿ç”¨ Web Speech APIï¼‰
    function speakText(text) {
      if ('speechSynthesis' in window) {
        // å–æ¶ˆå½“å‰æœ—è¯»
        speechSynthesis.cancel();
        // åˆ›å»ºè¯­éŸ³å¯¹è±¡
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';
        utterance.rate = 1.0;
        utterance.pitch = 1.0;
        speechSynthesis.speak(utterance);
      } else {
        showModal('âš ï¸ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³æ’­æ”¾åŠŸèƒ½ã€‚');
      }
    }

    // æ˜¾ç¤ºè‡ªå®šä¹‰å¼¹çª—
    function showModal(message) {
      document.getElementById('modal-body').innerHTML = message;
      document.getElementById('custom-modal').classList.add('active');
    }

    // å…³é—­å¼¹çª—
    function closeModal() {
      document.getElementById('custom-modal').classList.remove('active');
    }

    // ç‚¹å‡»é®ç½©å…³é—­
    document.getElementById('custom-modal').addEventListener('click', (e) => {
      if (e.target.id === 'custom-modal') {
        closeModal();
      }
    });

    // å°†è‹±æ–‡å¥å­æ‹†åˆ†ä¸ºå¯ç‚¹å‡»å•è¯ï¼ˆæ­£ç¡®ä¿ç•™ç©ºæ ¼å’Œæ ‡ç‚¹ï¼‰
    function makeWordsClickable(englishText) {
      const tokens = englishText.split(/(\s+|\b[\w'-]+\b)/).filter(token => token !== '');
      let html = '';
      for (const token of tokens) {
        if (/^\s+$/.test(token)) {
          html += token;
        } else if (/[\w'-]/.test(token)) {
          html += `<span class="clickable-word" data-word="${token}">${token}</span>`;
        } else {
          html += token;
        }
      }
      return html;
    }

    // æ¸²æŸ“å¯¹è¯ï¼ˆå¸¦å¯ç‚¹å‡»å•è¯å’Œæ’­æ”¾æŒ‰é’®ï¼‰
    function renderDialogue(dialogue) {
      const dialogueEl = document.getElementById('dialogue');
      let html = '';

      dialogue.forEach(line => {
        const clickableEnglish = makeWordsClickable(line.english);
        html += `
          <div class="dialog-line">
            <div class="speaker">${line.speaker}:</div>
            <div class="english">
              ${clickableEnglish}
              <button class="play-btn" onclick="speakText('${line.english.replace(/'/g, "\\'")}')">â–¶</button>
            </div>
            <div class="chinese">${line.chinese}</div>
          </div>
        `;
      });

      dialogueEl.innerHTML = html;

      // äº‹ä»¶å§”æ‰˜ï¼šç‚¹å‡»å•è¯è§¦å‘ AI ç¿»è¯‘
      dialogueEl.addEventListener('click', async (e) => {
        if (e.target.classList.contains('clickable-word')) {
          const word = e.target.getAttribute('data-word');
          const originalText = e.target.textContent;

          if (e.target.classList.contains('loading-word')) return;

          e.target.classList.add('loading-word');
          e.target.textContent = 'â‹¯';

          try {
            const translation = await translateWord(word);
            showModal(`<strong>"${originalText}"</strong> çš„æ„æ€æ˜¯ï¼š<br><br>${translation}`);
          } catch (err) {
            showModal(`ç¿»è¯‘å¤±è´¥ï¼š<br>${err.message}`);
          } finally {
            e.target.classList.remove('loading-word');
            e.target.textContent = originalText;
          }
        }
      });
    }

    // ä¸»å­¦ä¹ æµç¨‹
    async function startLearning() {
      const btn = document.getElementById('learnBtn');
      const errorEl = document.getElementById('error');
      const dialogueEl = document.getElementById('dialogue');

      btn.disabled = true;
      errorEl.classList.add('hidden');
      dialogueEl.innerHTML = '<div style="text-align:center; padding:20px;">ğŸ§  æ­£åœ¨ç”Ÿæˆå¤šè½®å®ç”¨å¯¹è¯ï¼ˆå«ä¸­è‹±å¯¹ç…§ï¼‰...</div>';

      try {
        const scene = getSelectedScene();
        const dialogue = await generateDialogue(scene);
        renderDialogue(dialogue);
      } catch (err) {
        errorEl.textContent = `âŒ é”™è¯¯: ${err.message}`;
        errorEl.classList.remove('hidden');
        dialogueEl.innerHTML = '';
      } finally {
        btn.disabled = false;
      }
    }

    // é¡µé¢åŠ è½½æ—¶æ¢å¤é…ç½®
    window.addEventListener('DOMContentLoaded', loadConfig);
  </script>
</body>
</html>
